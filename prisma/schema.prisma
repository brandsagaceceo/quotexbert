// quotexbert - AI-powered home repair estimate platform + job board
// Full-stack platform with Clerk auth, roles, messaging, and notifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?  // Added name field
  role      String   // "admin" | "contractor" | "homeowner"
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  contractorProfile    ContractorProfile?
  homeownerProfile     HomeownerProfile?
  billing             ContractorBilling?
  leads               Lead[]            @relation("HomeownerLeads")
  claimedLeads        Lead[]            @relation("ContractorLeads")
  acceptedLeads       Lead[]            @relation("AcceptedLeads")
  savedJobs           SavedJob[]
  messagesSent        Message[]         @relation("MessageSender")
  messagesReceived    Message[]         @relation("MessageReceiver")
  typingIndicators    TypingIndicator[] @relation("TypingIndicators")
  notifications       Notification[]
  homeownerContracts  Contract[]        @relation("HomeownerContracts")
  contractorContracts Contract[]        @relation("ContractorContracts")
  reviewsGiven        Review[]          @relation("HomeownerReviews")
  reviewsReceived     Review[]          @relation("ContractorReviews")
  
  // New conversation relations
  homeownerConversations Conversation[] @relation("HomeownerConversations")
  contractorConversations Conversation[] @relation("ContractorConversations")
  sentMessages        ConversationMessage[] @relation("SentMessages")
  receivedMessages    ConversationMessage[] @relation("ReceivedMessages")
  quotes              Quote[]
  
  @@map("users")
}

model ContractorProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyName     String
  trade           String   // "plumbing", "electrical", "general", etc.
  bio             String?
  city            String?
  serviceRadiusKm Int      @default(25)
  website         String?
  phone           String?
  verified        Boolean  @default(false)
  avgRating       Float    @default(0)
  reviewCount     Int      @default(0)
  isActive        Boolean  @default(true)
  
  portfolio       PortfolioItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("contractor_profiles")
}

model Lead {
  id               String           @id @default(cuid())
  title            String
  description      String
  budget           Float
  zipCode          String
  category         String
  status           String           @default("open") // "open" | "claimed" | "assigned" | "closed"
  claimed          Boolean          @default(false)
  published        Boolean          @default(true)
  photos           String           @default("[]") // JSON string of photo URLs/paths
  userId           String?          // Added userId field for homeowner
  
  homeownerId      String
  homeowner        User             @relation("HomeownerLeads", fields: [homeownerId], references: [id])
  
  contractorId     String?
  contractor       User?            @relation("ContractorLeads", fields: [contractorId], references: [id])
  
  acceptedById     String?
  acceptedBy       User?            @relation("AcceptedLeads", fields: [acceptedById], references: [id])
  
  Thread           Thread?
  savedBy          SavedJob[]
  charges          Charge[]
  contract         Contract?
  reviews          Review[]
  conversations    Conversation[]
  quotes           Quote[]
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  @@index([category])
  @@index([zipCode])
  @@map("leads")
}

model SavedJob {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId  String
  job    Lead   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, jobId])
  @@map("saved_jobs")
}

model Thread {
  id        String    @id @default(cuid())
  leadId    String    @unique
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  messages  Message[]
  
  createdAt DateTime  @default(now())
  
  @@map("threads")
}

model Message {
  id       String @id @default(cuid())
  threadId String
  thread   Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  body     String
  
  fromUserId String
  fromUser   User   @relation("MessageSender", fields: [fromUserId], references: [id])
  
  toUserId   String
  toUser     User   @relation("MessageReceiver", fields: [toUserId], references: [id])
  
  createdAt  DateTime @default(now())
  readAt     DateTime?
  deliveredAt DateTime?
  
  @@index([threadId, createdAt])
  @@map("messages")
}

model TypingIndicator {
  id       String @id @default(cuid())
  threadId String
  userId   String
  user     User   @relation("TypingIndicators", fields: [userId], references: [id], onDelete: Cascade)
  
  startedAt DateTime @default(now())
  expiresAt DateTime
  
  @@unique([threadId, userId])
  @@map("typing_indicators")
}

model Notification {
  id          String  @id @default(cuid())
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String  // "job_accepted" | "new_message" | "quote_received" | "quote_accepted"
  title       String  // Notification title
  message     String  // Notification message
  payload     Json?   // Additional flexible data
  read        Boolean @default(false)
  
  relatedId   String? // ID of related job, conversation, quote, etc.
  relatedType String? // "job" | "conversation" | "quote"
  
  createdAt   DateTime @default(now())
  
  @@index([userId, read, createdAt(sort: Desc)])
  @@map("notifications")
}

// Legacy models for existing affiliate system
model Affiliate {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  name          String?
  email         String?  @unique
  referralCode  String   @unique
  payoutPercent Int      @default(50)
  notes         String?
  
  @@map("affiliates")
}

model Referral {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  affiliateId  String
  leadId       String?
  visitorIp    String?
  userAgent    String?
  
  @@map("referrals")
}

model ProMembership {
  id        String   @id @default(cuid())
  email     String   @unique
  stripeId  String?
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("pro_memberships")
}

model ContractorBilling {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeCustomerId     String?  @unique
  monthlyCapCents      Int      @default(5000) // $50.00 default cap
  isPaused             Boolean  @default(false)
  spendThisMonthCents  Int      @default(0)
  resetOn              DateTime @default(now())
  
  charges              Charge[]
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("contractor_billing")
}

model Charge {
  id            String           @id @default(cuid())
  contractorId  String
  contractor    ContractorBilling @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  leadId        String
  lead          Lead             @relation(fields: [leadId], references: [id])
  amountCents   Int
  stripePaymentIntentId String? @unique
  status        String           @default("pending") // "pending" | "succeeded" | "failed"
  
  createdAt     DateTime         @default(now())
  
  @@map("charges")
}

model LeadPricing {
  id          String @id @default(cuid())
  trade       String @unique
  city        String @default("default") // "default" for general pricing
  priceCents  Int    @default(900) // $9.00 default
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([trade, city])
  @@map("lead_pricing")
}

model Contract {
  id                String   @id @default(cuid())
  leadId            String   @unique
  lead              Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  homeownerId       String
  homeowner         User     @relation("HomeownerContracts", fields: [homeownerId], references: [id])
  
  contractorId      String
  contractor        User     @relation("ContractorContracts", fields: [contractorId], references: [id])
  
  title             String
  description       String
  scope             String   @default("") // Detailed scope of work
  totalAmountCents  Int      // Total contract amount in cents
  
  status            String   @default("draft") // "draft" | "sent" | "accepted" | "completed" | "cancelled"
  homeownerAccepted Boolean  @default(false)
  contractorAccepted Boolean @default(false)
  
  pdfUrl            String?  // URL to generated PDF
  
  items             ContractItem[]
  
  sentAt            DateTime?
  acceptedAt        DateTime? // When both parties accepted
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("contracts")
}

model ContractItem {
  id          String   @id @default(cuid())
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Int      @default(1)
  unitPrice   Int      // Price per unit in cents
  totalPrice  Int      // quantity * unitPrice
  
  createdAt   DateTime @default(now())
  
  @@map("contract_items")
}

model HomeownerProfile {
  id       String  @id @default(cuid())
  userId   String  @unique
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name     String?
  city     String?
  phone    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("homeowner_profiles")
}

model PortfolioItem {
  id           String   @id @default(cuid())
  contractorId String
  contractor   ContractorProfile @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  title        String
  caption      String?
  projectType  String   @default("general") // "kitchen", "bathroom", "electrical", "plumbing", etc.
  beforeImages String   @default("[]") // JSON array of before photo URLs
  afterImages  String   @default("[]")  // JSON array of after photo URLs
  imageUrl     String?  // Legacy single image support
  
  createdAt    DateTime @default(now())
  
  @@map("portfolio_items")
}

model Review {
  id           String   @id @default(cuid())
  leadId       String
  contractorId String
  homeownerId  String
  
  lead         Lead     @relation(fields: [leadId], references: [id])
  contractor   User     @relation("ContractorReviews", fields: [contractorId], references: [id])
  homeowner    User     @relation("HomeownerReviews", fields: [homeownerId], references: [id])
  
  rating       Int      // 1-5 star rating
  title        String?  // Review title/summary
  text         String?  // Detailed review text
  
  // Detailed rating categories
  qualityRating      Int? // Quality of work (1-5)
  timelinessRating   Int? // On-time completion (1-5)
  communicationRating Int? // Communication skills (1-5)
  cleanlinessRating  Int? // Cleanup after work (1-5)
  valueRating        Int? // Value for money (1-5)
  
  // Project details
  projectType  String?  // Type of work done
  projectCost  Float?   // Actual cost of project
  projectDuration String? // How long project took
  
  // Review status and moderation
  status       String   @default("published") // "published", "pending", "hidden"
  isVerified   Boolean  @default(false) // Verified by platform
  
  // Helpful/response metrics
  helpfulCount Int      @default(0)
  responseText String?  // Contractor's response to review
  responseDate DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([leadId, homeownerId]) // One review per homeowner per lead
  @@map("reviews")
}

// New Conversation System for Job Communication
model Conversation {
  id           String   @id @default(cuid())
  jobId        String
  job          Lead     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  homeownerId  String
  homeowner    User     @relation("HomeownerConversations", fields: [homeownerId], references: [id])
  
  contractorId String
  contractor   User     @relation("ContractorConversations", fields: [contractorId], references: [id])
  
  status       String   @default("active") // "active" | "closed" | "archived"
  lastMessageAt DateTime @default(now())
  
  messages     ConversationMessage[]
  quotes       Quote[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([jobId, homeownerId, contractorId])
  @@map("conversations")
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId       String
  sender         User         @relation("SentMessages", fields: [senderId], references: [id])
  
  senderRole     String       // "homeowner" | "contractor" | "system"
  
  receiverId     String
  receiver       User         @relation("ReceivedMessages", fields: [receiverId], references: [id])
  
  receiverRole   String       // "homeowner" | "contractor" | "system"
  
  content        String
  type           String       @default("text") // "text" | "notification" | "quote" | "image"
  
  attachments    String       @default("[]") // JSON array of attachment URLs
  
  readAt         DateTime?
  deliveredAt    DateTime?    @default(now())
  
  createdAt      DateTime     @default(now())
  
  @@index([conversationId, createdAt])
  @@map("conversation_messages")
}

// AI-Generated Quote System
model Quote {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  jobId          String
  job            Lead         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  contractorId   String
  contractor     User         @relation(fields: [contractorId], references: [id])
  
  // Quote content generated by AI
  title          String
  description    String
  scope          String       // Detailed scope of work extracted from conversation
  
  // Pricing breakdown
  laborCost      Float        @default(0)
  materialCost   Float        @default(0)
  totalCost      Float
  
  items          QuoteItem[]
  
  // AI analysis metadata
  aiAnalysis     String?      // AI's analysis of the conversation
  extractedRequirements String? // Requirements extracted from chat
  confidenceScore Float       @default(0) // AI confidence in the quote (0-1)
  
  // Quote status and workflow
  status         String       @default("draft") // "draft" | "sent" | "accepted" | "rejected" | "expired"
  isEdited       Boolean      @default(false) // True if contractor edited AI-generated quote
  
  // Timeline
  sentAt         DateTime?
  acceptedAt     DateTime?
  rejectedAt     DateTime?
  expiresAt      DateTime?    // Optional expiration date
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@map("quotes")
}

model QuoteItem {
  id          String  @id @default(cuid())
  quoteId     String
  quote       Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  category    String  // "labor" | "materials" | "permits" | "other"
  description String
  quantity    Float   @default(1)
  unitPrice   Float
  totalPrice  Float
  
  notes       String? // Additional notes for this item
  
  createdAt   DateTime @default(now())
  
  @@map("quote_items")
}
