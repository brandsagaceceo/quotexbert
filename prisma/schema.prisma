// quotexbert - AI-powered home repair estimate platform + job board
// Full-stack platform with Clerk auth, roles, messaging, and notifications

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?  // Added name field
  role      String?  // "admin" | "contractor" | "homeowner" (null until user selects role during onboarding)
  lastSeen  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Stripe integration
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  subscriptionPlan     String?  // 'handyman' | 'renovation' | 'general' for tier subscriptions
  subscriptionStatus   String?  // 'active' | 'canceled' | 'past_due' | 'unpaid'
  subscriptionInterval String?  // 'month' | 'year'
  subscriptionCurrentPeriodStart DateTime?
  subscriptionCurrentPeriodEnd   DateTime?
  selectedCategories   String?  @default("[]") // JSON array of category IDs contractor selected
  
  // Manual subscription override (for COMP accounts, testing, etc.)
  proOverrideEnabled   Boolean? @default(false) // If true, override takes precedence
  proOverrideTier      String?  // 'FREE' | 'HANDYMAN' | 'RENOVATION' | 'GENERAL' (highest tier)
  proOverrideExpiresAt DateTime? // Null means no expiration
  proOverrideReason    String?  // Explanation for the override (e.g., "internal testing", "partnership")
  proOverrideSetBy     String?  // Admin email who set the override
  proOverrideSetAt     DateTime? // When the override was set
  
  // Clerk integration
  clerkUserId          String?  @unique
  isActive             Boolean  @default(true)
  
  // Relations
  contractorProfile    ContractorProfile?
  homeownerProfile     HomeownerProfile?
  billing             ContractorBilling?
  leads               Lead[]            @relation("HomeownerLeads")
  claimedLeads        Lead[]            @relation("ContractorLeads")
  acceptedLeads       Lead[]            @relation("AcceptedLeads")
  jobApplications     JobApplication[]  @relation("ContractorApplications")
  jobAcceptances      JobAcceptance[]   @relation("ContractorAcceptances")
  savedJobs           SavedJob[]
  messagesSent        Message[]         @relation("MessageSender")
  messagesReceived    Message[]         @relation("MessageReceiver")
  typingIndicators    TypingIndicator[] @relation("TypingIndicators")
  notifications       Notification[]
  homeownerContracts  Contract[]        @relation("HomeownerContracts")
  contractorContracts Contract[]        @relation("ContractorContracts")
  reviewsGiven        Review[]          @relation("HomeownerReviews")
  reviewsReceived     Review[]          @relation("ContractorReviews")
  
  // New conversation relations
  homeownerConversations Conversation[] @relation("HomeownerConversations")
  contractorConversations Conversation[] @relation("ContractorConversations")
  sentMessages        ConversationMessage[] @relation("SentMessages")
  receivedMessages    ConversationMessage[] @relation("ReceivedMessages")
  quotes              Quote[]
  
  // Payment relations - UPDATED FOR SUBSCRIPTION MODEL
  subscriptions       ContractorSubscription[] @relation("ContractorSubscriptions")
  paymentMethods      PaymentMethod[]
  transactions        Transaction[]
  
  // AI Estimates
  aiEstimates         AIEstimate[]   @relation("HomeownerEstimates")
  savedProjects       SavedProject[] @relation("HomeownerSavedProjects")
  
  // AI Visualizer
  visualizerSubscription VisualizerSubscription?
  visualizerGenerations  VisualizerGeneration[]
  
  @@map("users")
}

model ContractorProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  companyName     String
  trade           String   // "plumbing", "electrical", "general", etc.
  bio             String?
  city            String?
  serviceRadiusKm Int      @default(25)
  website         String?
  phone           String?
  verified        Boolean  @default(false)
  avgRating       Float    @default(0)
  reviewCount     Int      @default(0)
  isActive        Boolean  @default(true)
  profilePhoto    String?  // Added for profile photo storage
  coverPhoto      String?  // Added for cover photo storage
  
  portfolio       PortfolioItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("contractor_profiles")
}

model Lead {
  id               String           @id @default(cuid())
  title            String
  description      String
  budget           String           // Changed from Float to String to store budget ranges
  zipCode          String
  category         String
  status           String           @default("draft") // "draft" | "open" | "reviewing" | "assigned" | "completed" | "closed"
  claimed          Boolean          @default(false)
  published        Boolean          @default(false) // Changed default to false - homeowner controls when to publish
  photos           String           @default("[]") @db.Text // JSON array of photo URLs
  userId           String?          // Added userId field for homeowner
  maxContractors   Int              @default(3) // Maximum contractors that can apply
  acceptedContractors String        @default("[]") // JSON array of contractor IDs who accepted the job (max 3)
  
  // Auto-follow-up tracking
  viewCount        Int              @default(0) // Track how many contractors viewed the job
  followUpSent     Boolean          @default(false) // Track if 48hr no-response follow-up was sent
  viewedNoBidFollowUpSent Boolean   @default(false) // Track if viewed-but-no-bid follow-up was sent
  
  homeownerId      String
  homeowner        User             @relation("HomeownerLeads", fields: [homeownerId], references: [id])
  
  contractorId     String?
  contractor       User?            @relation("ContractorLeads", fields: [contractorId], references: [id])
  
  acceptedById     String?          // Final selected contractor
  acceptedBy       User?            @relation("AcceptedLeads", fields: [acceptedById], references: [id])
  
  applications     JobApplication[] // Multiple contractor applications
  acceptances      JobAcceptance[]  // Multiple contractor acceptances (max 3)
  Thread           Thread?
  savedBy          SavedJob[]
  charges          Charge[]
  contract         Contract?
  reviews          Review[]
  conversations    Conversation[]
  quotes           Quote[]
  aiEstimate       AIEstimate?      // Link back to the original AI estimate
  savedProject     SavedProject?    @relation("SavedProjectToLead")
  
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  @@index([category])
  @@index([zipCode])
  @@index([status])
  @@index([published])
  @@map("leads")
}

model JobApplication {
  id            String           @id @default(cuid())
  
  leadId        String
  lead          Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  contractorId  String
  contractor    User             @relation("ContractorApplications", fields: [contractorId], references: [id], onDelete: Cascade)
  
  status        String           @default("pending") // "pending" | "accepted" | "rejected" | "withdrawn"
  message       String?          // Optional application message from contractor
  proposedPrice String?          // Contractor's price quote
  estimatedDays Int?             // Estimated completion time
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  @@unique([leadId, contractorId]) // One application per contractor per job
  @@index([contractorId])
  @@index([leadId])
  @@index([status])
  @@map("job_applications")
}

model JobAcceptance {
  id            String           @id @default(cuid())
  
  leadId        String
  lead          Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  contractorId  String
  contractor    User             @relation("ContractorAcceptances", fields: [contractorId], references: [id], onDelete: Cascade)
  
  status        String           @default("accepted") // "accepted" | "quoted" | "selected" | "withdrawn"
  message       String?          // Optional message from contractor
  quoteAmount   String?          // Contractor's quote amount
  estimatedDays Int?             // Estimated completion time
  
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  @@unique([leadId, contractorId]) // One acceptance per contractor per job
  @@index([contractorId])
  @@index([leadId])
  @@index([status])
  @@map("job_acceptances")
}

model SavedJob {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId  String
  job    Lead   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, jobId])
  @@map("saved_jobs")
}

model Thread {
  id        String    @id @default(cuid())
  leadId    String    @unique
  lead      Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  messages  Message[]
  
  createdAt DateTime  @default(now())
  
  @@map("threads")
}

model Message {
  id       String @id @default(cuid())
  threadId String
  thread   Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  body     String
  
  fromUserId String
  fromUser   User   @relation("MessageSender", fields: [fromUserId], references: [id])
  
  toUserId   String
  toUser     User   @relation("MessageReceiver", fields: [toUserId], references: [id])
  
  createdAt  DateTime @default(now())
  readAt     DateTime?
  deliveredAt DateTime?
  
  @@index([threadId, createdAt])
  @@map("messages")
}

model TypingIndicator {
  id       String @id @default(cuid())
  threadId String
  userId   String
  user     User   @relation("TypingIndicators", fields: [userId], references: [id], onDelete: Cascade)
  
  startedAt DateTime @default(now())
  expiresAt DateTime
  
  @@unique([threadId, userId])
  @@map("typing_indicators")
}

model Notification {
  id          String  @id @default(cuid())
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String  // "job_accepted" | "new_message" | "quote_received" | "quote_accepted"
  title       String  // Notification title
  message     String  // Notification message
  payload     Json?   // Additional flexible data
  read        Boolean @default(false)
  
  relatedId   String? // ID of related job, conversation, quote, etc.
  relatedType String? // "job" | "conversation" | "quote"
  
  createdAt   DateTime @default(now())
  
  @@index([userId, read, createdAt(sort: Desc)])
  @@map("notifications")
}

// Legacy models for existing affiliate system
model Affiliate {
  id            String   @id @default(cuid())
  createdAt     DateTime @default(now())
  name          String?
  email         String?  @unique
  referralCode  String   @unique
  payoutPercent Int      @default(50)
  notes         String?
  
  @@map("affiliates")
}

model Referral {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  affiliateId  String
  leadId       String?
  visitorIp    String?
  userAgent    String?
  
  @@map("referrals")
}

model ProMembership {
  id        String   @id @default(cuid())
  email     String   @unique
  stripeId  String?
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("pro_memberships")
}

model ContractorBilling {
  id                   String   @id @default(cuid())
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeCustomerId     String?  @unique
  monthlyCapCents      Int      @default(5000) // $50.00 default cap
  isPaused             Boolean  @default(false)
  spendThisMonthCents  Int      @default(0)
  resetOn              DateTime @default(now())
  
  charges              Charge[]
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("contractor_billing")
}

model Charge {
  id            String           @id @default(cuid())
  contractorId  String
  contractor    ContractorBilling @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  leadId        String
  lead          Lead             @relation(fields: [leadId], references: [id])
  amountCents   Int
  stripePaymentIntentId String? @unique
  status        String           @default("pending") // "pending" | "succeeded" | "failed"
  
  createdAt     DateTime         @default(now())
  
  @@map("charges")
}

model LeadPricing {
  id          String @id @default(cuid())
  trade       String @unique
  city        String @default("default") // "default" for general pricing
  priceCents  Int    @default(900) // $9.00 default
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([trade, city])
  @@map("lead_pricing")
}

model Contract {
  id                String   @id @default(cuid())
  leadId            String   @unique
  lead              Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  
  homeownerId       String
  homeowner         User     @relation("HomeownerContracts", fields: [homeownerId], references: [id])
  
  contractorId      String
  contractor        User     @relation("ContractorContracts", fields: [contractorId], references: [id])
  
  title             String
  description       String
  scope             String   @default("") // Detailed scope of work
  totalAmountCents  Int      // Total contract amount in cents
  
  status            String   @default("draft") // "draft" | "sent" | "accepted" | "completed" | "cancelled"
  homeownerAccepted Boolean  @default(false)
  contractorAccepted Boolean @default(false)
  
  pdfUrl            String?  // URL to generated PDF
  
  items             ContractItem[]
  
  sentAt            DateTime?
  acceptedAt        DateTime? // When both parties accepted
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("contracts")
}

model ContractItem {
  id          String   @id @default(cuid())
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  description String
  quantity    Int      @default(1)
  unitPrice   Int      // Price per unit in cents
  totalPrice  Int      // quantity * unitPrice
  
  createdAt   DateTime @default(now())
  
  @@map("contract_items")
}

model HomeownerProfile {
  id       String  @id @default(cuid())
  userId   String  @unique
  user     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name         String?
  city         String?
  phone        String?
  profilePhoto String?  // Added for profile photo storage
  coverPhoto   String?  // Added for cover photo storage
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("homeowner_profiles")
}

model PortfolioItem {
  id           String   @id @default(cuid())
  contractorId String
  contractor   ContractorProfile @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  
  title        String
  description  String?  // Detailed project description
  caption      String?  // Short social media style caption
  projectType  String   @default("general") // "kitchen", "bathroom", "electrical", "plumbing", etc.
  beforeImages String   @default("[]") // JSON array of before photo URLs
  afterImages  String   @default("[]")  // JSON array of after photo URLs
  imageUrl     String?  // Legacy single image support
  
  // Project details
  projectCost  String?  // "1000-2000" format for budget ranges
  duration     String?  // "2 weeks", "3 days", etc.
  materials    String?  // Materials used
  location     String?  // City or general area
  clientStory  String?  // Client testimonial or story
  
  // Social features
  isPublic     Boolean  @default(true)  // Whether visible to potential clients
  isPinned     Boolean  @default(false) // Pin to top of contractor profile
  tags         String   @default("[]")  // JSON array of tags like ["modern", "luxury", "eco-friendly"]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@map("portfolio_items")
}

model Review {
  id           String   @id @default(cuid())
  leadId       String
  contractorId String
  homeownerId  String
  
  lead         Lead     @relation(fields: [leadId], references: [id])
  contractor   User     @relation("ContractorReviews", fields: [contractorId], references: [id])
  homeowner    User     @relation("HomeownerReviews", fields: [homeownerId], references: [id])
  
  rating       Int      // 1-5 star rating
  title        String?  // Review title/summary
  text         String?  // Detailed review text
  
  // Detailed rating categories
  qualityRating      Int? // Quality of work (1-5)
  timelinessRating   Int? // On-time completion (1-5)
  communicationRating Int? // Communication skills (1-5)
  cleanlinessRating  Int? // Cleanup after work (1-5)
  valueRating        Int? // Value for money (1-5)
  
  // Project details
  projectType  String?  // Type of work done
  projectCost  Float?   // Actual cost of project
  projectDuration String? // How long project took
  
  // Review status and moderation
  status       String   @default("published") // "published", "pending", "hidden"
  isVerified   Boolean  @default(false) // Verified by platform
  
  // Helpful/response metrics
  helpfulCount Int      @default(0)
  responseText String?  // Contractor's response to review
  responseDate DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([leadId, homeownerId]) // One review per homeowner per lead
  @@map("reviews")
}

// New Conversation System for Job Communication
model Conversation {
  id           String   @id @default(cuid())
  jobId        String
  job          Lead     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  homeownerId  String
  homeowner    User     @relation("HomeownerConversations", fields: [homeownerId], references: [id])
  
  contractorId String
  contractor   User     @relation("ContractorConversations", fields: [contractorId], references: [id])
  
  status       String   @default("active") // "active" | "closed" | "archived"
  lastMessageAt DateTime @default(now())
  
  messages     ConversationMessage[]
  quotes       Quote[]
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([jobId, homeownerId, contractorId])
  @@map("conversations")
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId       String
  sender         User         @relation("SentMessages", fields: [senderId], references: [id])
  
  senderRole     String       // "homeowner" | "contractor" | "system"
  
  receiverId     String
  receiver       User         @relation("ReceivedMessages", fields: [receiverId], references: [id])
  
  receiverRole   String       // "homeowner" | "contractor" | "system"
  
  content        String
  type           String       @default("text") // "text" | "notification" | "quote" | "image"
  
  attachments    String       @default("[]") // JSON array of attachment URLs
  
  readAt         DateTime?
  deliveredAt    DateTime?    @default(now())
  
  createdAt      DateTime     @default(now())
  
  @@index([conversationId, createdAt])
  @@map("conversation_messages")
}

// AI-Generated Quote System
model Quote {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  jobId          String
  job            Lead         @relation(fields: [jobId], references: [id], onDelete: Cascade)
  
  contractorId   String
  contractor     User         @relation(fields: [contractorId], references: [id])
  
  // Quote content generated by AI
  title          String
  description    String
  scope          String       // Detailed scope of work extracted from conversation
  
  // Pricing breakdown
  laborCost      Float        @default(0)
  materialCost   Float        @default(0)
  totalCost      Float
  
  items          QuoteItem[]
  
  // AI analysis metadata
  aiAnalysis     String?      // AI's analysis of the conversation
  extractedRequirements String? // Requirements extracted from chat
  confidenceScore Float       @default(0) // AI confidence in the quote (0-1)
  
  // Quote status and workflow
  status         String       @default("draft") // "draft" | "sent" | "accepted" | "rejected" | "expired"
  isEdited       Boolean      @default(false) // True if contractor edited AI-generated quote
  
  // Timeline
  sentAt         DateTime?
  acceptedAt     DateTime?
  rejectedAt     DateTime?
  expiresAt      DateTime?    // Optional expiration date
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@map("quotes")
}

model QuoteItem {
  id          String  @id @default(cuid())
  quoteId     String
  quote       Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  
  category    String  // "labor" | "materials" | "permits" | "other"
  description String
  quantity    Float   @default(1)
  unitPrice   Float
  totalPrice  Float
  
  notes       String? // Additional notes for this item
  
  createdAt   DateTime @default(now())
  
  @@map("quote_items")
}

model ContractorSubscription {
  id                String   @id @default(cuid())
  contractorId      String
  contractor        User     @relation("ContractorSubscriptions", fields: [contractorId], references: [id], onDelete: Cascade)
  
  // Subscription details
  category          String   // "plumbing", "electrical", "general", etc.
  status            String   @default("active") // "active" | "canceled" | "past_due" | "paused"
  
  // Pricing
  monthlyPrice      Float    @default(29.99)
  currency          String   @default("usd")
  
  // Stripe integration
  stripeSubscriptionId String? @unique
  stripeCustomerId     String?
  stripePriceId        String? // Stripe price ID for this category
  
  // Billing cycle
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  nextBillingDate      DateTime?
  
  // Trial and cancellation
  trialStart          DateTime?
  trialEnd            DateTime?
  canceledAt          DateTime?
  cancelAtPeriodEnd   Boolean  @default(false)
  
  // Access control
  canClaimLeads       Boolean  @default(true)
  canViewLeads        Boolean  @default(true)
  leadsThisMonth      Int      @default(0)
  monthlyLeadLimit    Int      @default(100) // Optional lead limit
  
  // Relations
  transactions        Transaction[]
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  @@unique([contractorId, category])
  @@map("contractor_subscriptions")
}

model PaymentMethod {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Stripe data
  stripePaymentMethodId String @unique
  type             String   // "card" | "bank_account"
  
  // Card/Bank details (from Stripe)
  last4            String?
  brand            String?  // "visa", "mastercard", etc.
  expMonth         Int?
  expYear          Int?
  
  // Status
  isDefault        Boolean  @default(false)
  isActive         Boolean  @default(true)
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("payment_methods")
}

model Transaction {
  id            String   @id @default(cuid())
  subscriptionId String?
  subscription  ContractorSubscription? @relation(fields: [subscriptionId], references: [id])
  
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  type          String   // "subscription_payment" | "refund" | "credit"
  amount        Float
  description   String
  category      String?  // Which category this payment is for
  
  // External references
  stripeTransactionId String?
  stripeInvoiceId     String?
  
  // Status
  status        String   @default("pending") // "pending" | "completed" | "failed"
  
  // Billing period this transaction covers
  periodStart   DateTime?
  periodEnd     DateTime?
  
  metadata      String?  // JSON for additional data
  
  createdAt     DateTime @default(now())
  
  @@map("transactions")
}

model Analytics {
  id          String    @id @default(cuid())
  eventName   String
  eventData   Json?
  timestamp   DateTime  @default(now())
  userId      String?
  sessionId   String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())

  @@index([eventName, timestamp])
  @@index([userId, timestamp])
  @@map("analytics")
}

// AI Estimate Model - Stores all AI-generated estimates for homeowners
model AIEstimate {
  id                String           @id @default(cuid())
  
  // User relationship
  homeownerId       String?          // Optional - can be anonymous initially
  homeowner         User?            @relation("HomeownerEstimates", fields: [homeownerId], references: [id], onDelete: Cascade)
  
  // Estimate details
  description       String           // Original description from user
  minCost           Float            // Minimum estimated cost
  maxCost           Float            // Maximum estimated cost
  confidence        Float            // AI confidence score (0-100)
  
  // AI analysis
  aiPowered         Boolean          @default(true)
  enhancedDescription String?        // AI-enhanced description
  factors           String           @default("[]") // JSON array of cost factors
  reasoning         String?          // AI reasoning for the estimate
  
  // Media attachments
  hasVoice          Boolean          @default(false)
  imageCount        Int              @default(0)
  images            String           @default("[]") // JSON array of image URLs
  
  // Status and visibility
  status            String           @default("draft") // "draft" | "saved" | "posted"
  isPublic          Boolean          @default(false)  // Whether posted to job board
  
  // Breakdown items (renovation items)
  items             EstimateItem[]
  
  // Lead relationship (if posted to job board)
  leadId            String?          @unique
  lead              Lead?            @relation(fields: [leadId], references: [id], onDelete: SetNull)
  savedProject      SavedProject?    @relation("SavedProjectEstimate")
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  @@index([homeownerId])
  @@index([status])
  @@index([isPublic])
  @@index([createdAt])
  @@map("ai_estimates")
}

// Individual items within an AI estimate
model EstimateItem {
  id            String       @id @default(cuid())
  
  estimateId    String
  estimate      AIEstimate   @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  
  // Item details
  category      String       // "flooring", "painting", "plumbing", etc.
  description   String       // Description of the item
  minCost       Float        // Minimum cost for this item
  maxCost       Float        // Maximum cost for this item
  
  // Item selection
  selected      Boolean      @default(true) // Whether homeowner wants to include this in job posting
  
  // Additional details
  quantity      Float?       // Optional quantity (sq ft, units, etc.)
  unit          String?      // Optional unit of measurement
  notes         String?      // Optional notes from homeowner or AI
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@index([estimateId])
  @@map("estimate_items")
}

// SavedProject - Combines AI Estimates with Visualizer results for easy management
model SavedProject {
  id                  String           @id @default(cuid())
  
  // User relationship
  homeownerId         String
  homeowner           User             @relation("HomeownerSavedProjects", fields: [homeownerId], references: [id], onDelete: Cascade)
  
  // Project details
  title               String           // User-friendly project name
  description         String           // Project description
  category            String           // Job category
  location            String?          // City/address
  budget              String?          // Budget range or estimate
  
  // Media
  photos              String           @default("[]") @db.Text // JSON array of uploaded photo URLs
  visualizerImages    String           @default("[]") // JSON array of AI visualizer result URLs
  
  // AI Data
  aiEstimateId        String?          @unique
  aiEstimate          AIEstimate?      @relation("SavedProjectEstimate", fields: [aiEstimateId], references: [id], onDelete: SetNull)
  
  estimateSummary     String?          // JSON object with cost range, materials, etc.
  
  // Status
  status              String           @default("draft") // "draft" | "posted" | "archived"
  postedAsLeadId      String?          @unique
  postedAsLead        Lead?            @relation("SavedProjectToLead", fields: [postedAsLeadId], references: [id], onDelete: SetNull)
  
  // Metadata
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  
  @@index([homeownerId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
  @@map("saved_projects")
}

// ============================================
// AI HOME VISUALIZER TABLES
// ============================================

// Tracks AI visualizer subscription and usage
model VisualizerSubscription {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Subscription details
  isPaid                Boolean  @default(false)
  stripeSubscriptionId  String?  @unique
  monthlyGenerationsUsed Int     @default(0)
  lastResetDate         DateTime @default(now())
  
  // Limits
  freeMonthlyLimit      Int      @default(10)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("visualizer_subscriptions")
}

// Stores AI visualizer generations
model VisualizerGeneration {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Images
  beforeImageUrl  String   // Original room photo
  afterImageUrl   String   // AI-generated result
  
  // User selections
  roomType        String?  // "living_room", "kitchen", "bedroom", "bathroom", "basement"
  flooringStyle   String?  // "tile", "vinyl", "hardwood", "laminate", "carpet"
  flooringColor   String?  // "light_oak", "dark_walnut", "gray", "white", etc.
  wallColor       String?  // "white", "beige", "gray", "blue", etc.
  designStyle     String?  // "modern", "farmhouse", "luxury", "minimalist", "industrial"
  customRequest   String?  // Free-text design request
  
  // AI details
  aiModel         String?  // Which AI model was used
  promptUsed      String?  // The actual prompt sent to AI
  processingTime  Int?     // Time in milliseconds
  
  // Metadata
  wasSentToQuote  Boolean  @default(false) // If user sent these images to quote flow
  quoteId         String?  // Reference to AIEstimate if created
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId])
  @@index([createdAt])
  @@map("visualizer_generations")
}

// ============================================
// EMAIL TRACKING & AFFILIATE LEADS
// ============================================

// Tracks all emails sent by the system
model EmailEvent {
  id               String   @id @default(cuid())
  type             String   // 'welcome' | 'new_job' | 'new_message' | 'lead_capture' | 'affiliate_lead'
  to               String   // Recipient email
  userId           String?  // Related user ID if applicable
  relatedJobId     String?  // Related job ID if applicable
  relatedMessageId String?  // Related message ID if applicable
  status           String   // 'sent' | 'failed'
  error            String?  // Error message if failed
  createdAt        DateTime @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("email_events")
}

// Stores affiliate lead submissions
model AffiliateLead {
  id          String   @id @default(cuid())
  email       String   @unique
  refCode     String?  // Affiliate referral code
  landingUrl  String?  // Which landing page they came from
  ip          String?  // IP address for spam prevention
  userAgent   String?  // Browser user agent
  createdAt   DateTime @default(now())
  
  @@index([email])
  @@index([refCode])
  @@index([createdAt])
  @@map("affiliate_leads")
}

// Logs all Stripe webhook events for debugging
model StripeWebhookLog {
  id        String   @id @default(cuid())
  type      String   // Event type (checkout.session.completed, invoice.payment_succeeded, etc.)
  eventId   String   @unique // Stripe event ID for deduplication
  data      String?  // JSON payload (optional, can be large)
  processed Boolean  @default(false)
  error     String?  // Error message if processing failed
  createdAt DateTime @default(now())
  
  @@index([type])
  @@index([createdAt])
  @@index([processed])
  @@map("stripe_webhook_logs")
}
